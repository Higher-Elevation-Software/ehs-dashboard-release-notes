name: Aggregate release note (on repository_dispatch)

on:
  repository_dispatch:
    types: [release-note]

env:
  TARGET_BRANCH: ${{ github.event.repository.default_branch }}

permissions:
  contents: write

jobs:
  add-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate and parse payload
        id: parse
        run: |
          set -euo pipefail
          event="$GITHUB_EVENT_PATH"
          component=$(jq -r '.client_payload.component // ""' "$event")
          sha=$(jq -r '.client_payload.sha // ""' "$event")
          title=$(jq -r '.client_payload.title // ""' "$event")
          summary=$(jq -r '.client_payload.summary // ""' "$event")
          pr=$(jq -r '.client_payload.pr // ""' "$event")
          deploy_time=$(jq -r '.client_payload.deploy_time // ""' "$event")
          environment=$(jq -r '.client_payload.environment // ""' "$event")

          if [ -z "$component" ] || [ -z "$sha" ] || [ -z "$title" ]; then
            echo "Missing required fields: component, sha, and title are required" >&2
            exit 1
          fi

          # Defaults
          [ -z "$summary" ] && summary="$title"
          [ -z "$deploy_time" ] && deploy_time=$(date -u +%Y%m%dT%H%M%SZ)
          [ -z "$environment" ] && environment="production"

          short_sha=${sha:0:7}
          safe_component=$(echo "$component" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]-' '-')
          fname="releases/${deploy_time}_${safe_component}_${short_sha}.md"

          mkdir -p releases
          cat > "$fname" <<MARKDOWN
---
component: $component
sha: $sha
deploy_time: $deploy_time
pr: $pr
environment: $environment
---

# $title

**Component:** $component  
**SHA:** \\`$sha\\`  
**Deployed:** $deploy_time (UTC)  
**Environment:** $environment

$summary

_More details or escalation info here as appropriate._
MARKDOWN

          echo "fname=$fname" >> "$GITHUB_OUTPUT"

      - name: Regenerate index
        run: |
          set -euo pipefail
          echo "# EHS Dashboard — Release Notes" > index.md
          echo "" >> index.md
          echo "This page is auto-generated by CI. See \`releases/\` for individual release notes." >> index.md
          echo "" >> index.md
          echo "## Releases" >> index.md
          echo "" >> index.md
          for f in $(ls -1 releases/*.md 2>/dev/null | sort -r); do
            basename=$(basename "$f")
            title_line=$(sed -n '1,5p' "$f" | sed -n '1p')
            echo "- [$basename]($f) — $title_line" >> index.md
          done || true

      - name: Commit and push
        run: |
          set -euo pipefail
          git config user.name "Release Bot"
          git config user.email "ci@higherelevationsoftware.com"
          git add -A
          git commit -m "Add release note: ${{ steps.parse.outputs.fname }}" || exit 0
          git push origin HEAD:${TARGET_BRANCH}
