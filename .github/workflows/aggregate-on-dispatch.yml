name: Aggregate release note (on repository_dispatch)

on:
  repository_dispatch:
    types: [release-note]

env:
  TARGET_BRANCH: ${{ github.event.repository.default_branch }}
  TARGET_BRANCH_OVERRIDE: ${{ github.event.client_payload.target_branch }}

permissions:
  contents: write

jobs:
  add-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Validate, Parse, and Enhance with Gemini
        id: parse
        env:
          GH_TOKEN: ${{ secrets.AGGREGATOR_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail
          
          # Install dependencies
          pip install google-generativeai requests

          event="$GITHUB_EVENT_PATH"
          component=$(jq -r '.client_payload.component // ""' "$event")
          sha=$(jq -r '.client_payload.sha // ""' "$event")
          title=$(jq -r '.client_payload.title // ""' "$event")
          summary=$(jq -r '.client_payload.summary // ""' "$event")
          pr=$(jq -r '.client_payload.pr // ""' "$event")
          deploy_time=$(jq -r '.client_payload.deploy_time // ""' "$event")
          environment=$(jq -r '.client_payload.environment // ""' "$event")
          target_branch=$(jq -r '.client_payload.target_branch // ""' "$event")

          if [ -z "$component" ] || [ -z "$sha" ] || [ -z "$title" ]; then
            echo "Missing required fields: component, sha, and title are required" >&2
            exit 1
          fi

          # Defaults
          [ -z "$summary" ] && summary="$title"
          [ -z "$deploy_time" ] && deploy_time=$(date -u +%Y%m%dT%H%M%SZ)
          [ -z "$environment" ] && environment="production"
          [ -z "$target_branch" ] && target_branch="${TARGET_BRANCH_OVERRIDE:-}"
          [ -z "$target_branch" ] && target_branch="$TARGET_BRANCH"

          # Fetch PR Context
          repo_name="Higher-Elevation-Software/$component"
          pr_title=""
          pr_body=""

          echo "Attempting to fetch PR details for $repo_name..."
          if [ -n "$pr" ] && [ "$pr" != "null" ]; then
             echo "Fetching PR #$pr..."
             # Fetch PR JSON or return ERROR on failure
             json=$(gh pr view "$pr" -R "$repo_name" --json title,body 2>&1 || echo "ERROR")
             
             # Check if gh command succeeded
             if [[ "$json" == "ERROR" ]] || [[ "$json" == *"graphql error"* ]] || [[ "$json" == *"Could not resolve to a PullRequest"* ]]; then
                echo "Failed to fetch PR #$pr via gh CLI."
                echo "Error output: $json"
             else
                # Parse JSON safely
                pr_title=$(echo "$json" | jq -r .title 2>/dev/null || echo "")
                pr_body=$(echo "$json" | jq -r .body 2>/dev/null || echo "")
                
                if [ -n "$pr_title" ]; then
                    echo "Found PR #$pr details."
                else
                    echo "Failed to parse JSON for PR #$pr."
                    echo "Raw output: $json"
                fi
             fi
          elif [ -n "$sha" ]; then
             echo "Searching for PR associated with SHA $sha..."
             # Try to find PR by SHA
             json=$(gh pr list -R "$repo_name" --search "$sha" --state merged --json number,title,body --limit 1 2>&1 | jq '.[0] // empty' || echo "ERROR")
              if [[ "$json" != "ERROR" ]] && [ -n "$json" ]; then
                pr_title=$(echo "$json" | jq -r .title)
                pr_body=$(echo "$json" | jq -r .body)
                pr=$(echo "$json" | jq -r .number)
                echo "Found PR #$pr via SHA."
             else
                echo "No PR found for SHA $sha or error occurred."
                if [[ "$json" == "ERROR" ]]; then echo "Error details: $(gh pr list -R "$repo_name" --search "$sha" --state merged --json number,title,body --limit 1 2>&1)"; fi
             fi
          fi

          short_sha=${sha:0:7}
          safe_component=$(echo "$component" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]-' '-')
          fname="releases/${deploy_time}_${safe_component}_${short_sha}.md"

          mkdir -p releases

          # Export variables for Python
          export component
          export sha
          export title
          export summary
          export pr
          export deploy_time
          export environment
          export target_branch
          export fname
          export pr_title
          export pr_body

          python3 - <<'PY'
          import os
          import google.generativeai as genai
          from textwrap import dedent

          component = os.environ["component"]
          sha = os.environ["sha"]
          title = os.environ["title"]
          summary = os.environ["summary"]
          pr = os.environ["pr"]
          deploy_time = os.environ["deploy_time"]
          environment = os.environ["environment"]
          fname = os.environ["fname"]
          
          pr_title = os.environ.get("pr_title", "")
          pr_body = os.environ.get("pr_body", "")
          gemini_api_key = os.environ.get("GEMINI_API_KEY", "")

          final_summary = summary
          
          # AI Enhancement Logic
          if gemini_api_key and (pr_title or pr_body):
              try:
                  genai.configure(api_key=gemini_api_key)
                  model = genai.GenerativeModel('gemini-pro')
                  
                  prompt = f"""
                  You are writing release notes for a public changelog. 
                  The audience is end-users, so be concise, user-friendly, and avoid purely technical jargon if possible.
                  
                  Inputs:
                  - Component: {component}
                  - Commit Message: {title}
                  - Commit Details: {summary}
                  - PR Title: {pr_title}
                  - PR Description: {pr_body}
                  
                  Instructions:
                  1. Look for a section named "Release Notes" in the PR Description. If it exists, prioritize that content.
                  2. Summarize the changes in 1-3 sentences.
                  3. Use active voice.
                  4. Output ONLY the summary text. Do not include markdown headers like "## Summary".
                  """
                  
                  response = model.generate_content(prompt)
                  if response.text:
                      final_summary = response.text.strip()
                      print("Gemini generated content successfully.")
              except Exception as e:
                  print(f"Gemini generation failed: {e}")
                  # Fallback to original summary is already set

          content = dedent(
              f"""\
              ---
              component: {component}
              sha: {sha}
              deploy_time: {deploy_time}
              pr: {pr}
              environment: {environment}
              ---

              # {title}

              **Component:** {component}  
              **SHA:** `{sha}`  
              **Deployed:** {deploy_time} (UTC)  
              **Environment:** {environment}

              {final_summary}

              _More details or escalation info here as appropriate._
              """
          )

          with open(fname, "w", encoding="utf-8") as f:
              f.write(content)
              
          print(f"Created release file: {fname}")
          PY

          echo "fname=$fname" >> "$GITHUB_OUTPUT"
          echo "target_branch=$target_branch" >> "$GITHUB_OUTPUT"

      - name: Debug payload and workspace
        run: |
          set -euo pipefail
          target_branch="${{ steps.parse.outputs.target_branch }}"
          echo "Event path: $GITHUB_EVENT_PATH"
          echo "Workspace contents:"
          ls -la
          echo "Releases dir:"
          ls -la releases || true
          echo "Target branch: $target_branch"

      - name: Regenerate index
        run: |
          set -euo pipefail
          echo "# EHS Dashboard — Release Notes" > index.md
          echo "" >> index.md
          echo "This page is auto-generated by CI. See \`releases/\` for individual release notes." >> index.md
          echo "" >> index.md
          echo "## Releases" >> index.md
          echo "" >> index.md
          for f in $(ls -1 releases/*.md 2>/dev/null | sort -r); do
            basename=$(basename "$f")
            title_line=$(grep -m1 "^# " "$f" | sed 's/^# //')
            [ -z "$title_line" ] && title_line=$(sed -n '1p' "$f")
            echo "- [$basename]($f) — $title_line" >> index.md
          done || true

      - name: Commit and push
        run: |
          set -euo pipefail
          git config user.name "Release Bot"
          git config user.email "ci@higherelevationsoftware.com"
          git add -A
          git commit -m "Add release note: ${{ steps.parse.outputs.fname }}" || exit 0
          git push origin HEAD:${{ steps.parse.outputs.target_branch }}
